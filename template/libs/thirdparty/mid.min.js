var sampleRate=44100;function AudioPlayer(b,f,a){sampleRate=b.sampleRate;var c=2;var g=4096*4;var d=b.createScriptProcessor(g,0,c);d.onaudioprocess=function(h){e(h)};function e(m){if(f.finished){if(a){f.reset();f.finished=false}else{d.disconnect();return}}var l=m.outputBuffer.getChannelData(0);var k=m.outputBuffer.getChannelData(1);var h=f.generate(g);for(var j=0;j<g;++j){l[j]=h[j*2];k[j]=h[j*2+1]}}return{"play":function(){d.connect(b.destination)},"pause":function(){d.disconnect()}}}function MidiFile(g){function a(q){var r=q.read(4);var i=q.readInt32();return{"id":r,"length":i,"data":q.read(i)}}var o;function c(w){var u={};u.deltaTime=w.readVarInt();var t=w.readInt8();if((t&240)==240){if(t==255){u.type="meta";var r=w.readInt8();var s=w.readVarInt();switch(r){case 0:u.subtype="sequenceNumber";if(s!=2){throw"Expected length for sequenceNumber event is 2, got "+s}u.number=w.readInt16();return u;case 1:u.subtype="text";u.text=w.read(s);return u;case 2:u.subtype="copyrightNotice";u.text=w.read(s);return u;case 3:u.subtype="trackName";u.text=w.read(s);return u;case 4:u.subtype="instrumentName";u.text=w.read(s);return u;case 5:u.subtype="lyrics";u.text=w.read(s);return u;case 6:u.subtype="marker";u.text=w.read(s);return u;case 7:u.subtype="cuePoint";u.text=w.read(s);return u;case 32:u.subtype="midiChannelPrefix";if(s!=1){throw"Expected length for midiChannelPrefix event is 1, got "+s}u.channel=w.readInt8();return u;case 47:u.subtype="endOfTrack";if(s!=0){throw"Expected length for endOfTrack event is 0, got "+s}return u;case 81:u.subtype="setTempo";if(s!=3){throw"Expected length for setTempo event is 3, got "+s}u.microsecondsPerBeat=((w.readInt8()<<16)+(w.readInt8()<<8)+w.readInt8());return u;case 84:u.subtype="smpteOffset";if(s!=5){throw"Expected length for smpteOffset event is 5, got "+s}var q=w.readInt8();u.frameRate={0:24,32:25,64:29,96:30}[q&96];u.hour=q&31;u.min=w.readInt8();u.sec=w.readInt8();u.frame=w.readInt8();u.subframe=w.readInt8();return u;case 88:u.subtype="timeSignature";if(s!=4){throw"Expected length for timeSignature event is 4, got "+s}u.numerator=w.readInt8();u.denominator=Math.pow(2,w.readInt8());u.metronome=w.readInt8();u.thirtyseconds=w.readInt8();return u;case 89:u.subtype="keySignature";if(s!=2){throw"Expected length for keySignature event is 2, got "+s}u.key=w.readInt8(true);u.scale=w.readInt8();return u;case 127:u.subtype="sequencerSpecific";u.data=w.read(s);return u;default:u.subtype="unknown";u.data=w.read(s);return u}u.data=w.read(s);return u}else{if(t==240){u.type="sysEx";var s=w.readVarInt();u.data=w.read(s);return u}else{if(t==247){u.type="dividedSysEx";var s=w.readVarInt();u.data=w.read(s);return u}else{throw"Unrecognised MIDI event type byte: "+t}}}}else{var v;if((t&128)==0){v=t;t=o}else{v=w.readInt8();o=t}var i=t>>4;u.channel=t&15;u.type="channel";switch(i){case 8:u.subtype="noteOff";u.noteNumber=v;u.velocity=w.readInt8();return u;case 9:u.noteNumber=v;u.velocity=w.readInt8();if(u.velocity==0){u.subtype="noteOff"}else{u.subtype="noteOn"}return u;case 10:u.subtype="noteAftertouch";u.noteNumber=v;u.amount=w.readInt8();return u;case 11:u.subtype="controller";u.controllerType=v;u.value=w.readInt8();return u;case 12:u.subtype="programChange";u.programNumber=v;return u;case 13:u.subtype="channelAftertouch";u.amount=v;return u;case 14:u.subtype="pitchBend";u.value=v+(w.readInt8()<<7);return u;default:throw"Unrecognised MIDI event type: "+i}}}stream=Stream(g);var k=a(stream);if(k.id!="MThd"||k.length!=6){throw"Bad .mid file - header not found"}var f=Stream(k.data);var d=f.readInt16();var h=f.readInt16();var p=f.readInt16();if(p&32768){throw"Expressing time division in SMTPE frames is not supported yet"}else{ticksPerBeat=p}var j={"formatType":d,"trackCount":h,"ticksPerBeat":ticksPerBeat};var m=[];for(var e=0;e<j.trackCount;e++){m[e]=[];var l=a(stream);if(l.id!="MTrk"){throw"Unexpected chunk - expected MTrk, got "+l.id}var n=Stream(l.data);while(!n.eof()){var b=c(n);m[e].push(b)}}return{"header":j,"tracks":m}}function Replayer(h,c){var k=[];var o=120;var l=h.header.ticksPerBeat;var a=16;var d=[];var m;var e;function b(){var t={};var p=PianoProgram;function s(u,v){if(t[u]&&!t[u].released){t[u].noteOff()}generator=p.createNote(u,v);c.addGenerator(generator);t[u]=generator}function r(u,v){if(t[u]&&!t[u].released){t[u].noteOff(v)}}function q(u){p=PROGRAMS[u]||PianoProgram}return{"noteOn":s,"noteOff":r,"setProgram":q}}function g(){var t=null;var v=null;var p=null;for(var s=0;s<k.length;s++){if(k[s].ticksToNextEvent!=null&&(t==null||k[s].ticksToNextEvent<t)){t=k[s].ticksToNextEvent;v=s;p=k[s].nextEventIndex}}if(v!=null){var r=h.tracks[v][p];if(h.tracks[v][p+1]){k[v].ticksToNextEvent+=h.tracks[v][p+1].deltaTime}else{k[v].ticksToNextEvent=null}k[v].nextEventIndex+=1;for(var s=0;s<k.length;s++){if(k[s].ticksToNextEvent!=null){k[s].ticksToNextEvent-=t}}m={"ticksToEvent":t,"event":r,"track":v};var u=t/l;var q=u/(o/60);e+=q*c.sampleRate}else{m=null;e=null;n.finished=true}}function j(q){var t=new Array(q*2);var s=q;var p=0;while(true){if(e!=null&&e<=s){var r=Math.ceil(e);if(r>0){c.generateIntoBuffer(r,t,p);p+=r*2;s-=r;e-=r}i();g()}else{if(s>0){c.generateIntoBuffer(s,t,p);e-=s}break}}return t}function i(){var p=m.event;switch(p.type){case"meta":switch(p.subtype){case"setTempo":o=60000000/p.microsecondsPerBeat}break;case"channel":switch(p.subtype){case"noteOn":d[p.channel].noteOn(p.noteNumber,p.velocity);break;case"noteOff":d[p.channel].noteOff(p.noteNumber,p.velocity);break;case"programChange":d[p.channel].setProgram(p.programNumber);break}break}}function f(){for(var p=0;p<h.tracks.length;p++){k[p]={"nextEventIndex":0,"ticksToNextEvent":(h.tracks[p].length?h.tracks[p][0].deltaTime:null)}}for(var p=0;p<a;p++){d[p]=b()}e=0;g()}f();var n={"reset":f,"generate":j,"finished":false};return n}function Stream(g){var b=0;function e(j){var i=g.substr(b,j);b+=j;return i}function f(){var i=((g.charCodeAt(b)<<24)+(g.charCodeAt(b+1)<<16)+(g.charCodeAt(b+2)<<8)+g.charCodeAt(b+3));b+=4;return i}function a(){var i=((g.charCodeAt(b)<<8)+g.charCodeAt(b+1));b+=2;return i}function h(j){var i=g.charCodeAt(b);if(j&&i>127){i-=256}b+=1;return i}function c(){return b>=g.length}function d(){var j=0;while(true){var i=h();if(i&128){j+=(i&127);j<<=7}else{return j+i}}}return{"eof":c,"read":e,"readInt32":f,"readInt16":a,"readInt8":h,"readVarInt":d}}function SineGenerator(c){var a={"alive":true};var d=sampleRate/c;var b=0;a.generate=function(g,i,h){for(;h;h--){var f=b/d;var e=Math.sin(f*2*Math.PI);g[i++]+=e;g[i++]+=e;b++}};return a}function SquareGenerator(d,a){var b={"alive":true};var e=sampleRate/d;var c=0;b.generate=function(g,i,h){for(;h;h--){var f=((c/e)%1>a?1:-1);g[i++]+=f;g[i++]+=f;c++}};return b}function ADSRGenerator(c,i,k,h,l,j){var n={"alive":true};var f=sampleRate*h;var g=sampleRate*(h+l);var b=(i-k)/(g-f);var a=null;var e=null;var d=k/(sampleRate*j);var m=0;n.noteOff=function(){if(n.released){return}a=m;n.released=true;e=a+sampleRate*j};n.generate=function(p,t,s){if(!n.alive){return}var o=new Array(s*2);for(var r=0;r<s*2;r++){o[r]=0}c.generate(o,0,s);childOffset=0;while(s){if(a!=null){if(m<e){while(s&&m<e){var q=k-d*(m-a);p[t++]+=o[childOffset++]*q;p[t++]+=o[childOffset++]*q;m++;s--}}else{n.alive=false;return}}else{if(m<f){while(s&&m<f){var q=i*m/f;p[t++]+=o[childOffset++]*q;p[t++]+=o[childOffset++]*q;m++;s--}}else{if(m<g){while(s&&m<g){var q=i-b*(m-f);p[t++]+=o[childOffset++]*q;p[t++]+=o[childOffset++]*q;m++;s--}}else{while(s){p[t++]+=o[childOffset++]*k;p[t++]+=o[childOffset++]*k;m++;s--}}}}}};return n}function midiToFrequency(a){return 440*Math.pow(2,(a-69)/12)}PianoProgram={"attackAmplitude":0.2,"sustainAmplitude":0.1,"attackTime":0.02,"decayTime":0.3,"releaseTime":0.02,"createNote":function(a,b){var c=midiToFrequency(a);return ADSRGenerator(SineGenerator(c),this.attackAmplitude*(b/128),this.sustainAmplitude*(b/128),this.attackTime,this.decayTime,this.releaseTime)}};StringProgram={"createNote":function(a,b){var c=midiToFrequency(a);return ADSRGenerator(SineGenerator(c),0.5*(b/128),0.2*(b/128),0.4,0.8,0.4)}};PROGRAMS={41:StringProgram,42:StringProgram,43:StringProgram,44:StringProgram,45:StringProgram,46:StringProgram,47:StringProgram,49:StringProgram,50:StringProgram};function Synth(b){var c=[];function e(f){c.push(f)}function a(f){var g=new Array(f*2);d(f,g,0);return g}function d(h,f,j){for(var g=j;g<j+h*2;g++){f[g]=0}for(var g=c.length-1;g>=0;g--){c[g].generate(f,j,h);if(!c[g].alive){c.splice(g,1)}}}return{"sampleRate":b,"addGenerator":e,"generate":a,"generateIntoBuffer":d}};